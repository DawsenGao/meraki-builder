#!/bin/sh
#
# Mount/create JFFS2; bind mount /etc from /overlay/etc
#

OVERLAY_DIRS="etc"

mount_overlay() {
    if [ $(grep -c "/overlay" /proc/mounts) -eq 1 ]; then
        for dir in $OVERLAY_DIRS; do
            mkdir -p /overlay/.work/${dir}
            mkdir -p /overlay/.upper/${dir}
            mount -t overlay overlay -o rw,noatime,lowerdir=/${dir},upperdir=/overlay/.upper/${dir},workdir=/overlay/.work/${dir} /${dir}
        done
    fi
}

start() {
    mount_overlay
}

stop() {
    for dir in $OVERLAY_DIRS; do
        umount /${dir}
    done
}

restart() {
    stop
    start
}

case "$1" in
  start)
      start
    ;;
  stop)
      stop
    ;;
  restart|reload)
      restart
    ;;
  *)
    echo "Usage: $0 {start|stop|restart}"
    exit 1
esac

exit $?
